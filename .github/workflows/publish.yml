name: Release & Publish (Automated | Manual)

on:
  workflow_dispatch:   # allows manual trigger
  release:
    types: [published] # triggers automatically on GitHub releases

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Build package
      - name: Build package
        run: npm run build

      # 5. Determine NPM tag
      - name: Determine NPM tag
        id: tag
        run: |
          echo "RELEASE_TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV

          # Pre-release tags get published under `beta`
          if [[ "${GITHUB_REF_NAME}" == *"-beta"* ]] || [[ "${GITHUB_REF_NAME}" == *"-alpha"* ]]; then
            echo "PUBLISH_TAG=beta" >> $GITHUB_ENV
          else
            echo "PUBLISH_TAG=latest" >> $GITHUB_ENV
          fi

          # Safety fallback for manual triggers
          if [[ -z "${PUBLISH_TAG}" ]]; then
            echo "PUBLISH_TAG=latest" >> $GITHUB_ENV
          fi

      # 6. Publish package
      - name: Publish package
        run: npm publish --tag ${{ env.PUBLISH_TAG }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}